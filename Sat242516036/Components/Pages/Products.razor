@page "/products"
@using Microsoft.AspNetCore.Authorization
@using Sat242516036.Data
@using MyDbModels
@using Providers

@attribute [Authorize(Roles = "Admin")] 

@inject IMyDbModel_Provider Provider
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Ürün Yönetimi</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Ürün Yönetimi</h3>
        <button class="btn btn-primary" @onclick="OpenCreateModal">
            <i class="bi bi-plus-circle"></i> Yeni Ekle
        </button>
    </div>

    @* --- FİLTRELEME ALANI (Filtering) --- *@
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control" placeholder="Ürün Adı Ara..." 
                           @bind="filterName" @bind:event="oninput" @onkeyup="OnSearch" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" @onclick="ClearFilter">Temizle</button>
                </div>
            </div>
        </div>
    </div>

    @* --- LİSTELEME VE SIRALAMA (Listing & Sorting) --- *@
    <div class="table-responsive">
        <table class="table table-hover table-bordered">
            <thead class="table-light">
                <tr>
                    <th style="cursor:pointer" @onclick='() => Sort("Id")'>ID @SortIcon("Id")</th>
                    <th style="cursor:pointer" @onclick='() => Sort("ProductName")'>Ürün Adı @SortIcon("ProductName")</th>
                    <th style="cursor:pointer" @onclick='() => Sort("PointCost")'>Puan Değeri @SortIcon("PointCost")</th>
                    <th>Stok</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @if (products == null)
                {
                    <tr><td colspan="5" class="text-center">Yükleniyor...</td></tr>
                }
                else if (!products.Any())
                {
                    <tr><td colspan="5" class="text-center">Kayıt bulunamadı.</td></tr>
                }
                else
                {
                    @foreach (var item in products)
                    {
                        <tr>
                            <td>@item.Id</td>
                            <td>@item.ProductName</td>
                            <td>
                                <span class="badge bg-info text-dark">@item.PointCost Puan</span>
                            </td>
                            <td>@item.StockQuantity</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" @onclick="() => OpenEditModal(item)">
                                    Düzenle
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteProduct(item)">
                                    Sil
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @* --- SAYFALAMA (Pagination) --- *@
    @if (myModel.Parameters.TotalPageCount > 1)
    {
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(myModel.Parameters.PageNumber == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(myModel.Parameters.PageNumber - 1)">Önceki</button>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Sayfa @myModel.Parameters.PageNumber / @myModel.Parameters.TotalPageCount</span>
                </li>
                <li class="page-item @(myModel.Parameters.PageNumber == myModel.Parameters.TotalPageCount ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(myModel.Parameters.PageNumber + 1)">Sonraki</button>
                </li>
            </ul>
        </nav>
    }
</div>

@* --- EKLEME / GÜNCELLEME MODALI (Single Component Logic) --- *@
@if (showModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(currentProduct.Id == 0 ? "Yeni Ürün Ekle" : "Ürün Güncelle")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="currentProduct" OnValidSubmit="SaveProduct">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label>Ürün Adı</label>
                            <InputText @bind-Value="currentProduct.ProductName" class="form-control" />
                            <ValidationMessage For="() => currentProduct.ProductName" />
                        </div>
                        <div class="mb-3">
                            <label>Puan Değeri</label>
                            <InputNumber @bind-Value="currentProduct.PointCost" class="form-control" />
                            <ValidationMessage For="() => currentProduct.PointCost" />
                        </div>
                        <div class="mb-3">
                            <label>Stok Adedi</label>
                            <InputNumber @bind-Value="currentProduct.StockQuantity" class="form-control" />
                            <ValidationMessage For="() => currentProduct.StockQuantity" />
                        </div>
                         <div class="mb-3">
                            <label>Açıklama</label>
                            <InputTextArea @bind-Value="currentProduct.Description" class="form-control" />
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">İptal</button>
                            <button type="submit" class="btn btn-success">Kaydet</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Veri Modeli
    private MyDbModel<Product> myModel = new MyDbModel<Product>();
    private IEnumerable<Product> products;
    private Product currentProduct = new();

    // UI Kontrol
    private bool showModal = false;
    private string filterName = "";
    
    // Başlangıç
    protected override async Task OnInitializedAsync()
    {
        // Varsayılan sıralama
        myModel.Parameters.OrderBy = "Id"; 
        await LoadData();
    }

    // --- LİSTELEME VE FİLTRELEME ---
    private async Task LoadData()
    {
        // Filtreyi modele ekle
        myModel.Parameters.Where["ProductName"] = filterName;

        // PROVIDER ÜZERİNDEN VERİYİ ÇEK (Madde 22 Hierarşisi)
        // Provider -> UnitOfWork -> DbContext -> SP (sp_Products_List)
        myModel = (MyDbModel<Product>)await Provider.Execute(myModel, "sp_Products_List", isPagination: true);
        
        products = myModel.Items;
    }

    private async Task OnSearch()
    {
        myModel.Parameters.PageNumber = 1; // Aramada ilk sayfaya dön
        await LoadData();
    }

    private async Task ClearFilter()
    {
        filterName = "";
        await OnSearch();
    }

    // --- SIRALAMA ---
    private async Task Sort(string columnName)
    {
        if (myModel.Parameters.OrderBy == columnName)
            myModel.Parameters.OrderBy = columnName + " DESC"; // Tersi
        else
            myModel.Parameters.OrderBy = columnName;
            
        await LoadData();
    }

    private string SortIcon(string columnName)
    {
        if (myModel.Parameters.OrderBy == columnName) return "▼";
        if (myModel.Parameters.OrderBy == columnName + " DESC") return "▲";
        return "";
    }

    // --- SAYFALAMA ---
    private async Task ChangePage(int page)
    {
        myModel.Parameters.PageNumber = page;
        await LoadData();
    }

    // --- EKLEME VE GÜNCELLEME İŞLEMLERİ ---
    private void OpenCreateModal()
    {
        currentProduct = new Product();
        showModal = true;
    }

    private void OpenEditModal(Product item)
    {
        // Kopyasını alıyoruz ki iptal derse tablo bozulmasın
        currentProduct = new Product
        {
            Id = item.Id,
            ProductName = item.ProductName,
            PointCost = item.PointCost,
            StockQuantity = item.StockQuantity,
            Description = item.Description
        };
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task SaveProduct()
    {
        // Madde 23 Hiyerarşisi: Component -> Provider -> SP
        if (currentProduct.Id == 0)
        {
            // EKLEME (sp_Products_Ins)
            await Provider.Execute<Product>("sp_Products_Ins",
                ("Name", currentProduct.ProductName),
                ("Description", currentProduct.Description ?? ""),
                ("PointCost", currentProduct.PointCost),
                ("StockQuantity", currentProduct.StockQuantity)
            );
        }
        else
        {
            // GÜNCELLEME (sp_Products_Upd)
            await Provider.Execute<Product>("sp_Products_Upd",
                ("Id", currentProduct.Id),
                ("Name", currentProduct.ProductName),
                ("PointCost", currentProduct.PointCost),
                ("StockQuantity", currentProduct.StockQuantity)
            );
        }

        showModal = false;
        await LoadData(); // Listeyi yenile
    }

    // --- SİLME İŞLEMİ ---
    private async Task DeleteProduct(Product item)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"{item.ProductName} silinecek. Emin misiniz?");
        if (confirmed)
        {
            // SİLME (sp_Products_Del)
            await Provider.Execute<Product>("sp_Products_Del", ("Id", item.Id));
            await LoadData();
        }
    }
}